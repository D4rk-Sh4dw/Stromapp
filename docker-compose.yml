version: '3.8'

services:
  stromapp:
    build: .
    container_name: stromapp
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - ./prisma/dev.db:/app/prisma/dev.db
    environment:
      - DATABASE_URL=file:/app/prisma/dev.db
      - INFLUXDB_URL=${INFLUXDB_URL}
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET}
      - JWT_SECRET=${JWT_SECRET}
    # Optional: Command to ensure DB schema is pushed on start
    # Since we use SQLite volume, if it's empty we might need to push.
    # But usually `node server.js` is the command.
    # We can rely on the user running `npx prisma db push` locally on the volume file?
    # Or override command:
    # command: sh -c "npx prisma db push && node server.js"
    # But `npx` might not be in the final runner image if we pruned too much?
    # Standalone output includes minimal node_modules.
    # Prisma CLI might NOT be in standalone.
    # So we rely on the mounted DB being ready, or we accept that for now.

# If you want to run InfluxDB locally as well, uncomment this:
#  influxdb:
#    image: influxdb:2
#    container_name: influxdb
#    ports:
#      - "8086:8086"
#    volumes:
#      - influxdb-data:/var/lib/influxdb2
#    environment:
#      - DOCKER_INFLUXDB_INIT_MODE=setup
#      - DOCKER_INFLUXDB_INIT_USERNAME=admin
#      - DOCKER_INFLUXDB_INIT_PASSWORD=password123
#      - DOCKER_INFLUXDB_INIT_ORG=home
#      - DOCKER_INFLUXDB_INIT_BUCKET=energy

# volumes:
#   influxdb-data:
